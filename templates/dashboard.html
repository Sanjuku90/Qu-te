{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Bienvenue, {{ current_user.username }} üëã</h1>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Solde disponible</span>
                <span class="stat-value" id="current-balance">{{ "%.2f"|format(current_user.balance) }}$</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">D√©p√¥t actif</span>
                <span class="stat-value">{{ "%.2f"|format(current_user.deposit) }}$</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Qu√™tes aujourd'hui</span>
                <span class="stat-value" id="completed-count">{{ completed_today }}/4</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Gain par qu√™te</span>
                <span class="stat-value">{{ "%.2f"|format(current_user.deposit * 0.5) }}$</span>
            </div>
        </div>
    </div>
    
    {% if current_user.deposit == 0 %}
    <div class="alert alert-warning">
        <p>‚ö†Ô∏è Vous devez effectuer un d√©p√¥t minimum de 200$ pour d√©bloquer les qu√™tes. <a href="{{ url_for('deposit') }}">Faire un d√©p√¥t</a></p>
    </div>
    {% endif %}
    
    <h2 style="margin-bottom: 1.5rem;">Qu√™tes disponibles</h2>
    <div class="quests-list">
        {% for quest in quests|sort(attribute='order') %}
        {% set is_completed = quest.id in completed_quest_ids %}
        {% set previous_completed = loop.first or (quests|sort(attribute='order'))[loop.index0 - 1].id in completed_quest_ids %}
        {% set is_unlocked = previous_completed and not is_completed %}
        
        <div class="quest-card-horizontal {% if is_completed %}completed{% elif not previous_completed %}locked{% endif %}" id="quest-{{ quest.id }}">
            <div class="quest-number">{{ loop.index }}</div>
            <div class="quest-icon-box">
                {% if quest.icon == 'youtube' %}<i class="fab fa-youtube"></i>
                {% elif quest.icon == 'instagram' %}<i class="fab fa-instagram"></i>
                {% elif quest.icon == 'telegram' %}<i class="fab fa-telegram"></i>
                {% elif quest.icon == 'tiktok' %}<i class="fab fa-tiktok"></i>
                {% elif quest.icon == 'twitter' %}<i class="fab fa-twitter"></i>
                {% elif quest.icon == 'facebook' %}<i class="fab fa-facebook"></i>
                {% else %}<i class="fas fa-star"></i>{% endif %}
            </div>
            <div class="quest-content">
                <h3>{{ quest.title }}</h3>
                <p>{{ quest.description }}</p>
            </div>
            <div class="quest-reward-badge">
                +{{ "%.2f"|format(current_user.deposit * 0.5) }}$
            </div>
            <div class="quest-actions">
                {% if is_completed %}
                    <span class="quest-status-badge completed"><i class="fas fa-check"></i> Compl√©t√©e</span>
                {% elif is_unlocked and current_user.deposit > 0 %}
                    {% if quest.action_url %}
                    <a href="{{ quest.action_url }}" target="_blank" class="btn btn-secondary btn-sm">
                        <i class="fas fa-external-link-alt"></i> Effectuer
                    </a>
                    {% endif %}
                    <button class="btn btn-primary btn-sm" onclick="completeQuest({{ quest.id }})">
                        <i class="fas fa-check"></i> Valider
                    </button>
                {% elif not previous_completed %}
                    <span class="quest-status-badge locked"><i class="fas fa-lock"></i> Verrouill√©e</span>
                {% else %}
                    <span class="quest-status-badge disabled">Non disponible</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="dashboard-actions">
        <h3>Actions rapides</h3>
        <div class="action-buttons">
            <a href="{{ url_for('deposit') }}" class="btn btn-secondary">üí∞ Faire un d√©p√¥t</a>
            <button class="btn btn-outline" onclick="toggleWithdraw()">üí∏ Retirer des gains</button>
        </div>
        
        <div id="withdraw-form" class="withdraw-section" style="display: none;">
            <form method="POST" action="{{ url_for('request_withdrawal') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label>Montant √† retirer (max: {{ "%.2f"|format(current_user.balance) }}$)</label>
                    <input type="number" name="amount" step="0.01" min="0.01" max="{{ current_user.balance }}" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Adresse de portefeuille (BEP20)</label>
                    <input type="text" name="wallet_address" required placeholder="0x...">
                </div>
                <button type="submit" class="btn btn-primary">Demander le retrait</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
